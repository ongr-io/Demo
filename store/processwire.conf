server {
    listen 80;
    server_name   www.processwire.ongr.dev *.processwire.ongr.dev processwire.ongr.dev;
    index         index.php index.html;
    root          /var/www/store/processwire;
    default_type  application/x-php;

    ### SECURITY - Protect crucial files
    location ~ /\. {
        deny  all;
    }
    location ~ /(COPYRIGHT|LICENSE|README|htaccess)\.txt {
        deny  all;
    }
    location ~ ^/site(-[^/]+)?/assets/(.*\.php|backups|cache|config|install|logs|sessions) {
        deny  all;
    }
    location ~ ^/site(-[^/]+)?/install {
        deny  all;
    }
    location ~ ^/(site(-[^/]+)?|wire)/(config(-dev)?|index\.config)\.php {
        deny  all;
    }
    location ~ ^/((site(-[^/]+)?|wire)/modules|wire/core)/.*\.(inc|module|php|tpl) {
        deny  all;
    }
    location ~ ^/(site(-[^/]+)?|wire)/templates(-admin)?/.*\.(inc|html?|php|tpl) {
        deny  all;
    }

    ### GLOBAL REWRITE
    location / {
        try_files  $uri  $uri/  /index.php?it=$uri&$args;
    }

    # pass the PHP scripts to FastCGI server on local socket
    #
    location ~ .+\.php((/|\?).*)?$ {
        fastcgi_pass                unix:/var/run/php5-fpm.sock;
        fastcgi_index               index.php;
        fastcgi_split_path_info     ^(.+\.php)(.*)$;
        fastcgi_param               SCRIPT_FILENAME   $document_root$fastcgi_script_name;
        fastcgi_param               PATH_INFO         $fastcgi_path_info;
        fastcgi_param               HTTP_MOD_REWRITE  On;
        include                     fastcgi_params;

        expires                     off;
    }

    # redirect server error pages to the static page /40x.html
    #
    error_page  404  /404.html;
    location = /40x.html {
        root  /usr/share/nginx/html;
    }

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root  /usr/share/nginx/html;
    }

     ## Block download agenta
     if ($http_user_agent ~* LWP::Simple|wget|libwww-perl) {
        return 403;
     }

     ## Block some nasty robots
     if ($http_user_agent ~ (msnbot|Purebot|Baiduspider|Lipperhey|Mail.Ru|scrapbot) ) {
        return 403;
     }

     ## Deny referal spam
     if ( $http_referer ~* (jewelry|viagra|nude|girl|nudit|casino|poker|porn|sex|teen|babes) ) {
        return 403;
     }

    # deny scripts inside writable directories
    location ~* /(images|cache|media|logs|tmp)/.*.(php|pl|py|jsp|asp|sh|cgi)$ {
        return 403;
        error_page 403 /403_error.html;
    }

    ## Only allow these request methods ##
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 444;
    }
}
